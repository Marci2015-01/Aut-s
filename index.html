<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Forza Horizon 5 Mobile - Fix Controls</title>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; touch-action: none; }
        canvas { display: block; }
        
        #ui { position: absolute; top: 10px; right: 10px; pointer-events: none; }
        .speedo { background: rgba(255,255,255,0.8); border-radius: 50%; width: 80px; height: 80px; border: 3px solid #ff0055; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .val { font-size: 24px; font-weight: 900; color: #ff0055; }

        /* Mobil Gombok */
        .controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; pointer-events: none; }
        .btn-group { display: flex; gap: 10px; pointer-events: auto; }
        .btn { 
            width: 75px; height: 75px; background: rgba(0,0,0,0.5); 
            border: 3px solid white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: white; user-select: none;
            -webkit-user-select: none; touch-action: none;
        }
        .btn.active { background: rgba(255, 0, 85, 0.8); transform: scale(0.9); }
    </style>
</head>
<body>

    <div id="ui"><div class="speedo"><span class="val" id="kmh">0</span><span style="font-size:8px;">KM/H</span></div></div>

    <div class="controls">
        <div class="btn-group">
            <div class="btn" id="btn-left">◀</div>
            <div class="btn" id="btn-right">▶</div>
        </div>
        <div class="btn-group">
            <div class="btn" id="btn-rev">B</div>
            <div class="btn" id="btn-gas">G</div>
        </div>
    </div>

    <canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

let w, h, px = 14.5, py = 14.5, pa = 0, speed = 0, steer = 0, noseDive = 0;
const mapSize = 64;
const world = new Uint8Array(mapSize * mapSize);
const houseColors = ["#FFB6C1", "#FFD700", "#98FB98", "#FFA07A", "#00CED1"];
const worldColors = new Uint8Array(mapSize * mapSize);

for(let i=0; i<mapSize*mapSize; i++) {
    let tx = i % mapSize, ty = Math.floor(i / mapSize);
    if (tx % 14 === 0 || ty % 14 === 0) world[i] = 0;
    else if (Math.random() > 0.45) { world[i] = 1; worldColors[i] = Math.floor(Math.random() * 5); }
    if(tx == 0 || tx == mapSize-1 || ty == 0 || ty == mapSize-1) world[i] = 1;
}

// BEMENET KEZELÉS (PC + MOBIL)
const input = { gas: 0, brake: 0, left: 0, right: 0 };

function bind(id, action) {
    const el = document.getElementById(id);
    const start = (e) => { e.preventDefault(); input[action] = 1; el.classList.add('active'); };
    const end = (e) => { e.preventDefault(); input[action] = 0; el.classList.remove('active'); };
    
    el.addEventListener('pointerdown', start);
    el.addEventListener('pointerup', end);
    el.addEventListener('pointerleave', end);
    el.addEventListener('pointercancel', end);
}

bind('btn-gas', 'gas'); bind('btn-rev', 'brake');
bind('btn-left', 'left'); bind('btn-right', 'right');

// Billentyűzet támogatás
window.onkeydown = e => {
    if(e.key == "w" || e.key == "ArrowUp") input.gas = 1;
    if(e.key == "s" || e.key == "ArrowDown") input.brake = 1;
    if(e.key == "a" || e.key == "ArrowLeft") input.left = 1;
    if(e.key == "d" || e.key == "ArrowRight") input.right = 1;
};
window.onkeyup = e => {
    if(e.key == "w" || e.key == "ArrowUp") input.gas = 0;
    if(e.key == "s" || e.key == "ArrowDown") input.brake = 0;
    if(e.key == "a" || e.key == "ArrowLeft") input.left = 0;
    if(e.key == "d" || e.key == "ArrowRight") input.right = 0;
};

function update() {
    if (input.brake) {
        if (speed > 0.01) { speed -= 0.01; noseDive += (20 - noseDive) * 0.1; }
        else { speed -= 0.005; noseDive += (-10 - noseDive) * 0.1; }
    } else { noseDive *= 0.8; }

    if (input.gas) speed += 0.008;
    speed *= 0.98;
    
    if (Math.abs(speed) > 0.005) {
        let steerIn = input.right - input.left;
        pa += steerIn * 0.05 * Math.abs(speed) * 5 * (speed < 0 ? -1 : 1);
    }

    let nx = px + Math.cos(pa) * speed, ny = py + Math.sin(pa) * speed;
    if (world[Math.floor(ny) * mapSize + Math.floor(nx)] === 0) { px = nx; py = ny; }
    else { speed = -speed * 0.4; }
}

function draw() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
    update();

    const fov = 1.1;
    for(let x = 0; x < w; x+=4) {
        let rayA = (pa - fov/2) + (x/w) * fov;
        let dist = 0, wallIdx = -1, vx = Math.cos(rayA), vy = Math.sin(rayA);
        while(dist < 15) {
            dist += 0.1;
            let tx = px + vx * dist, ty = py + vy * dist;
            if(world[Math.floor(ty) * mapSize + Math.floor(tx)] === 1) { 
                wallIdx = Math.floor(ty) * mapSize + Math.floor(tx); break; 
            }
        }
        let wallH = h / (dist * Math.cos(rayA - pa));
        ctx.fillStyle = "#87CEEB"; ctx.fillRect(x, 0, 4, h/2 + noseDive);
        ctx.fillStyle = "#999"; ctx.fillRect(x, h/2 + noseDive, 4, h/2 - noseDive);
        if(wallIdx >= 0) {
            ctx.fillStyle = houseColors[worldColors[wallIdx]];
            ctx.fillRect(x, h/2 - wallH/2 + noseDive, 4, wallH);
        }
    }
    document.getElementById("kmh").innerText = Math.floor(Math.abs(speed) * 400);
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
