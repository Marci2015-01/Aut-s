<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Forza Mobile - Ultra Stable</title>
    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; outline: none; }
        body, html { 
            margin: 0; padding: 0; width: 100vw; height: 100vh; 
            overflow: hidden; background: #87CEEB; position: fixed; 
            font-family: sans-serif;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* Sebességmérő - Középen lent, hogy ne zavarja a sarkokat */
        #speed-hud {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: #ff0055; padding: 10px 20px;
            border-radius: 30px; border: 2px solid #ff0055; text-align: center; pointer-events: none;
        }

        /* Gombok - Két szélre elosztva */
        .btn {
            position: absolute; width: 85px; height: 85px;
            background: rgba(255,255,255,0.2); border: 3px solid #fff;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: white; font-size: 35px;
            touch-action: none; z-index: 100;
        }
        .btn.active { background: #ff0055; border-color: #ff0055; transform: scale(1.1); }

        /* Pozíciók: BAL OLDAL (Kormány) | JOBB OLDAL (Gáz/Fék) */
        #l { bottom: 120px; left: 20px; }
        #r { bottom: 20px; left: 20px; }
        #g { bottom: 120px; right: 20px; }
        #b { bottom: 20px; right: 20px; }
    </style>
</head>
<body>

    <div id="speed-hud">
        <span id="kmh" style="font-size: 32px; font-weight: 900;">0</span>
        <span style="font-size: 12px; color: white; margin-left: 5px;">KM/H</span>
    </div>

    <!-- BAL kéz: Kormányzás -->
    <div class="btn" id="l">◀</div>
    <div class="btn" id="r">▶</div>

    <!-- JOBB kéz: Gáz / Fék -->
    <div class="btn" id="g">↑</div>
    <div class="btn" id="b">↓</div>

    <canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

let w, h, px = 14.5, py = 14.5, pa = 0, speed = 0, noseDive = 0;
const mapSize = 64;
const world = new Uint8Array(mapSize * mapSize);
const houseColors = ["#FFB6C1", "#FFD700", "#98FB98", "#FFA07A", "#00CED1"];
const worldColors = new Uint8Array(mapSize * mapSize);

// Világ építése
for(let i=0; i<mapSize*mapSize; i++) {
    let tx = i % mapSize, ty = Math.floor(i / mapSize);
    if (tx % 14 === 0 || ty % 14 === 0) world[i] = 0;
    else if (Math.random() > 0.45) { world[i] = 1; worldColors[i] = Math.floor(Math.random() * 5); }
    if(tx == 0 || tx == mapSize-1 || ty == 0 || ty == mapSize-1) world[i] = 1;
}

const input = { g: 0, b: 0, l: 0, r: 0 };

function bind(id, act) {
    const el = document.getElementById(id);
    const start = (e) => { e.preventDefault(); input[act] = 1; el.classList.add('active'); };
    const end = (e) => { e.preventDefault(); input[act] = 0; el.classList.remove('active'); };
    el.addEventListener('touchstart', start, {passive: false});
    el.addEventListener('touchend', end, {passive: false});
    el.addEventListener('mousedown', start);
    el.addEventListener('mouseup', end);
}

bind('l', 'l'); bind('r', 'r'); bind('b', 'b'); bind('g', 'g');

function update() {
    if (input.b) {
        if (speed > 0.01) { speed -= 0.012; noseDive += (15 - noseDive) * 0.1; }
        else { speed -= 0.005; noseDive += (-10 - noseDive) * 0.1; }
    } else { noseDive *= 0.8; }
    if (input.g) speed += 0.009;
    speed *= 0.98;

    if (Math.abs(speed) > 0.005) {
        let sIn = input.r - input.l;
        pa += sIn * 0.05 * (speed < 0 ? -1 : 1);
    }
    let nx = px + Math.cos(pa) * speed, ny = py + Math.sin(pa) * speed;
    if (world[Math.floor(ny) * mapSize + Math.floor(nx)] === 0) { px = nx; py = ny; }
    else { speed = -speed * 0.4; }
}

function draw() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
    update();
    const fov = 1.0;
    const step = w < 600 ? 10 : 5; // Még erősebb optimalizáció mobilon
    
    for(let x = 0; x < w; x += step) {
        let rayA = (pa - fov/2) + (x/w) * fov;
        let dist = 0, wallIdx = -1, vx = Math.cos(rayA), vy = Math.sin(rayA);
        while(dist < 14) {
            dist += 0.2;
            let tx = px + vx * dist, ty = py + vy * dist;
            if(world[Math.floor(ty) * mapSize + Math.floor(tx)] === 1) { 
                wallIdx = Math.floor(ty) * mapSize + Math.floor(tx); break; 
            }
        }
        let wallH = h / (dist * Math.cos(rayA - pa));
        ctx.fillStyle = "#87CEEB"; ctx.fillRect(x, 0, step, h/2 + noseDive);
        ctx.fillStyle = "#A9A9A9"; ctx.fillRect(x, h/2 + noseDive, step, h/2 - noseDive);
        if(wallIdx >= 0) {
            ctx.fillStyle = houseColors[worldColors[wallIdx]];
            ctx.fillRect(x, h/2 - wallH/2 + noseDive, step, wallH);
        }
    }
    document.getElementById("kmh").innerText = Math.floor(Math.abs(speed) * 450);
    requestAnimationFrame(draw);
}

// Görgetés gátlása (Safety first)
document.addEventListener('touchmove', e => e.preventDefault(), {passive: false});

draw();
</script>
</body>
</html>
