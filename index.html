
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Forza Horizon 5 - Real Brake & Reverse</title>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        #ui { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; align-items: flex-end; padding: 50px; }
        .speedo { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 50%; width: 150px; height: 150px; border: 4px solid #ff0055; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #333; box-shadow: 0 0 25px rgba(255, 0, 85, 0.3); }
        .val { font-size: 50px; font-weight: 900; font-style: italic; line-height: 0.8; color: #ff0055; }
        #instr { position: absolute; top: 20px; left: 20px; color: #333; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 5px; border-left: 5px solid #ff0055; }
    </style>
</head>
<body>

    <div id="instr"><b>FH5 REVERSE UPDATE</b><br>‚å®Ô∏è <b>S</b>: F√©k, majd Tolat√°s<br>üéÆ <b>LT</b>: F√©k, majd Tolat√°s<br>üõ†Ô∏è <b>Y</b>: Jav√≠t√°s</div>

    <div id="ui">
        <div class="speedo">
            <span class="val" id="kmh">0</span>
            <span style="font-size:12px;font-weight:bold">KM/H</span>
        </div>
    </div>

    <canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

let w, h, px = 14.5, py = 14.5, pa = 0, speed = 0, steer = 0;
let damage = 0, cracks = [], noseDive = 0, shakes = 0;

const mapSize = 64;
const world = new Uint8Array(mapSize * mapSize);
const houseColors = ["#FFB6C1", "#FFD700", "#98FB98", "#FFA07A", "#00CED1"];
const worldColors = new Uint8Array(mapSize * mapSize);

for(let i=0; i<mapSize*mapSize; i++) {
    let tx = i % mapSize, ty = Math.floor(i / mapSize);
    if (tx % 14 === 0 || ty % 14 === 0) world[i] = 0;
    else if (Math.random() > 0.45) { world[i] = 1; worldColors[i] = Math.floor(Math.random() * 5); }
    if(tx == 0 || tx == mapSize-1 || ty == 0 || ty == mapSize-1) world[i] = 1;
}

const keys = {};
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

let gpIdx = null;
window.addEventListener("gamepadconnected", e => gpIdx = e.gamepad.index);

function onCollision() {
    shakes = 15;
    damage = Math.min(damage + 0.2, 1);
    cracks.push({ x: Math.random()*window.innerWidth, y: window.innerHeight/2 + Math.random()*100, len: 80, a: Math.random()*Math.PI*2 });
    if(gpIdx !== null) navigator.getGamepads()[gpIdx].vibrationActuator?.playEffect("dual-rumble", {duration: 150, strongMagnitude: 0.8});
}

function update() {
    const gp = gpIdx !== null ? navigator.getGamepads()[gpIdx] : null;
    let throttle = (keys['w'] || keys['arrowup']) ? 1 : 0;
    let brake = (keys['s'] || keys['arrowdown']) ? 1 : 0;
    let steerIn = (keys['a'] || keys['arrowleft']) ? -1 : (keys['d'] || keys['arrowright'] ? 1 : 0);

    if (gp) {
        throttle = Math.max(throttle, gp.buttons[7].value); // RT
        brake = Math.max(brake, gp.buttons[6].value);       // LT
        if (Math.abs(gp.axes[0]) > 0.1) steerIn = gp.axes[0];
        if (gp.buttons[3].pressed) { damage = 0; cracks = []; } // Y
    }

    // TOLAT√ÅS √âS F√âK LOGIKA
    if (brake > 0.1) {
        if (speed > 0.01) {
            speed -= 0.012 * brake; // F√©kez√©s
            noseDive += (brake * 25 - noseDive) * 0.15; // B√≥lint√°s el≈ëre
        } else {
            speed -= 0.005 * brake; // Tolat√°s
            noseDive += (brake * -15 - noseDive) * 0.1; // Orra megemelkedik tolat√°skor
        }
    } else {
        noseDive *= 0.85;
    }

    if (throttle > 0.1) speed += 0.008 * throttle;
    
    speed *= 0.982; // S√∫rl√≥d√°s

    const maxS = 0.18 * (1 - damage * 0.5);
    if (speed > maxS) speed = maxS;
    if (speed < -0.06) speed = -0.06; // Tolat√°si sebess√©gkorl√°t

    if (Math.abs(speed) > 0.005) {
        steer = steerIn * 0.05;
        // Tolat√°sn√°l az ir√°ny√≠t√°s megfordul
        const reverseMult = speed < 0 ? -1 : 1;
        pa += steer * Math.abs(speed) * 5 * reverseMult;
    }

    let nx = px + Math.cos(pa) * speed;
    let ny = py + Math.sin(pa) * speed;
    
    if (world[Math.floor(ny) * mapSize + Math.floor(nx)] === 0) {
        px = nx; py = ny;
    } else {
        if(Math.abs(speed) > 0.03) onCollision();
        speed = -speed * 0.4;
    }
}

function draw() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
    update();

    let sx = (Math.random()-0.5)*shakes, sy = (Math.random()-0.5)*shakes;
    shakes *= 0.9;

    // Raycasting render
    const fov = 1.1;
    for(let x = 0; x < w; x+=2) {
        let rayA = (pa - fov/2) + (x/w) * fov;
        let dist = 0, type = 0, wallIdx = 0, vx = Math.cos(rayA), vy = Math.sin(rayA);
        while(dist < 18) {
            dist += 0.05;
            let tx = px + vx * dist, ty = py + vy * dist;
            if(world[Math.floor(ty) * mapSize + Math.floor(tx)] === 1) { 
                type = 1; wallIdx = Math.floor(ty) * mapSize + Math.floor(tx);
                break; 
            }
        }
        let wallH = h / (dist * Math.cos(rayA - pa));
        
        ctx.fillStyle = "#87CEEB"; ctx.fillRect(x+sx, 0, 2, h/2 + noseDive + sy);
        ctx.fillStyle = "#A9A9A9"; ctx.fillRect(x+sx, h/2 + noseDive + sy, 2, h/2 - noseDive);

        if(type === 1) {
            ctx.fillStyle = houseColors[worldColors[wallIdx]];
            ctx.globalAlpha = Math.max(0, 1 - dist/18);
            ctx.fillRect(x+sx, h/2 - wallH/2 + noseDive + sy, 2, wallH);
            ctx.globalAlpha = 1;
        }
    }

    // BELS≈ê N√âZET
    ctx.save();
    ctx.translate(w/2 + steer*250 + sx, h - 170 + noseDive/2 + sy);
    
    // M≈±szerfal
    ctx.fillStyle = "#222"; 
    ctx.beginPath(); ctx.moveTo(-w, 200); ctx.lineTo(-450, 0); ctx.lineTo(450, 0); ctx.lineTo(w, 200); ctx.fill();
    
    // Korm√°ny
    ctx.strokeStyle = "#111"; ctx.lineWidth = 35;
    ctx.beginPath(); ctx.arc(0, 110, 160, Math.PI, 0); ctx.stroke();
    
    // M≈±szerfal f√©nyek (tolat√°sn√°l k√©kes f√©ny)
    if (speed < -0.01) {
        ctx.fillStyle = "rgba(0, 100, 255, 0.1)";
        ctx.fillRect(-200, -50, 400, 100);
    }
    
    ctx.restore();

    // Sz√©lv√©d≈ë reped√©sek
    ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 2;
    cracks.forEach(c => {
        ctx.beginPath(); ctx.moveTo(c.x, c.y);
        ctx.lineTo(c.x + Math.cos(c.a)*c.len, c.y + Math.sin(c.a)*c.len); ctx.stroke();
    });

    document.getElementById("kmh").innerText = Math.floor(Math.abs(speed) * 480);
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
